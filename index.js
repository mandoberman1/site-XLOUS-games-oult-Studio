const express = require('express');
const fs = require('fs');
const ejs = require('ejs');
const app = express();
const nodemailer = require('nodemailer');
const { v4: uuidv4 } = require('uuid');
const bcrypt = require('bcrypt');
const session = require('express-session');
const { user } = require('pg/lib/defaults.js');
const leoProfanity = require('leo-profanity');
const extraRU = [
    'ебал','ебать','','','','','', 'пенис','япи дорас','яша лава','яна члене','пидорас','япидорас','япидор','я пидор','пидорас','абортыш','абортышь','шаболда','ебанная','ебанный','ебаная','ебаный','пенис','','','','','','','','пидор', 'пидр', 'хуй', 'хер', 'ебать', 'ебан', 'ебло', 'гандон',
    'мудила', 'сука', 'сучка', 'блядь', 'блять', 'хуесос', 'долбаеб',
    'долбоеб', 'даун', 'ебанат', 'пошелнах', 'нахуй', 'нахер', 'уебище',
    'уёбище', 'гавно', 'говно', 'мудак', 'пидрила', 'ебака', 'херня',
    'шалава', 'проститука', 'проститутка', 'извращенец', 'гнида', 'мразь',
    'мерзота', 'выблядок', 'жопа', 'жопник', 'жопошник', 'гомик', 'гомосек',
    'тварь', 'сволочь', 'ублюдок', 'сукинсын', 'скотина', 'засранец',
    'обмудок', 'петух', 'петушара', 'чмо', 'подонок', 'недоносок',
    'тупица', 'идиот', 'кретин', 'овца', 'козёл', 'козел', 'уёбок', 'уебок',
    'выродок', 'ебырь', 'анал', 'анус', 'залупа', 'дрочить', 'дрочер',
    'дрисня', 'ссанина', 'обоссанец', 'обосранец', 'обмудень', 'залупа', 'пидорас','уёбок',
    'выблядок','петух', '6ля', '6лядь', '6лять', 'b3ъeб', 'cock', 'cunt', 'e6aль', 'ebal', 
    'eblan', 'eбaл', 'eбaть', 'eбyч', 'eбать', 'eбёт', 'eблантий', 'fuck', 'fucker', 'fucking',
    'xyёв', 'xyй', 'xyя', 'xуе', 'xуй', 'xую', 'zaeb', 'zaebal', 'zaebali', 'zaebat',
    'архипиздрит', 'ахуел', 'ахуеть', 'бздение', 'бздеть', 'бздех', 'бздецы', 'бздит',
    'бздицы', 'бздло', 'бзднуть', 'бздун', 'бздунья', 'бздюха', 'бздюшка', 'бздюшко',
    'бля', 'блябу', 'блябуду', 'бляд', 'бляди', 'блядина', 'блядище', 'блядки', 
    'блядовать', 'блядство', 'блядун', 'блядуны', 'блядунья', 'блядь', 'блядюга',
    'блять', 'вафел', 'вафлёр', 'взъебка', 'взьебка', 'взьебывать', 'въеб', 
    'въебался', 'въебенн', 'въебусь', 'въебывать', 'выблядок', 'выблядыш', 
    'выеб', 'выебать', 'выебен', 'выебнулся', 'выебон', 'выебываться', 
    'выпердеть', 'высраться', 'выссаться', 'вьебен', 'гавно', 'гавнюк', 'гавнючка',
    'гамно', 'гандон', 'гнид', 'гнида', 'гниды', 'говенка', 'говенный',
    'говешка', 'говназия', 'говнецо', 'говнище', 'говно', 'говноед', 
    'говнолинк', 'говночист', 'говнюк', 'говнюха', 'говнядина', 'говняк', 
    'говняный', 'говнять', 'гондон', 'доебываться', 'долбоеб', 'долбоёб', 
    'долбоящер', 'дрисня', 'дрист', 'дристануть', 'дристать', 'дристун',
    'дристуха', 'дрочелло', 'дрочена', 'дрочила', 'дрочилка', 'дрочистый'
    , 'дрочить', 'дрочка', 'дрочун', 'е6ал', 'е6ут', 'мать', 'мать', 'ёбaн', 
    'ебaть', 'ебyч', 'ебал', 'ебало', 'ебальник', 'ебан', 'ебанамать', 'ебанат',
    'ебаная', 'ёбаная', 'ебанический', 'ебанный', 'ебанныйврот', 'ебаное',
    'ебануть', 'ебануться', 'ёбаную', 'ебаный', 'ебанько', 'ебарь', 'ебат', 'ёбат',
    'ебатория', 'ебать', 'ебать-копать', 'ебаться', 'ебашить', 'ебёна', 'ебет',
    'ебёт', 'ебец', 'ебик', 'ебин', 'ебись', 'ебическая', 'ебки', 'ебла', 'еблан',
    'ебливый', 'еблище', 'ебло', 'еблыст', 'ебля', 'ёбн', 'ебнуть', 'ебнуться', 
    'ебня', 'ебошить', 'ебская', 'ебский', 'ебтвоюмать', 'ебун', 'ебут', 'ебуч', 
    'ебуче', 'ебучее', 'ебучий', 'ебучим', 'ебущ', 'ебырь', 'елда', 'елдак',
    'елдачить', 'жопа', 'жопу', 'заговнять', 'задрачивать', 'задристать',
    'задрота', 'зае6', 'заё6', 'заеб', 'заёб', 'заеба', 'заебал', 'заебанец', 
    'заебастая', 'заебастый', 'заебать', 'заебаться', 'заебашить', 'заебистое', 
    'заёбистое', 'заебистые', 'заёбистые', 'заебистый', 'заёбистый', 'заебись', 
    'заебошить', 'заебываться', 'залуп', 'залупа', 'залупаться', 'залупить',
    'залупиться', 'замудохаться', 'запиздячить', 'засерать', 'засерун', 'засеря', 
    'засирать', 'засрун', 'захуячить', 'заябестая', 'злоеб', 'злоебучая', 
    'злоебучее', 'злоебучий', 'ибанамат', 'ибонех', 'изговнять', 'изговняться', 
    'изъебнуться', 'ипать', 'ипаться', 'ипаццо', 'Какдвапальцаобоссать', 'конча', 
    'курва', 'курвятник', 'лох', 'лошарa', 'лошара', 'лошары', 'лошок', 'лярва',
    'малафья', 'манда', 'мандавошек', 'мандавошка', 'мандавошки', 'мандей',
    'мандень', 'мандеть', 'мандища', 'мандой', 'манду', 'мандюк', 'минет', 'минетчик',
    'минетчица', 'млять', 'мокрощелка', 'мокрощёлка', 'мразь', 'мудak', 'мудaк', 
    'мудаг', 'мудак', 'муде', 'мудель', 'мудеть', 'муди', 'мудил', 'мудила', 
    'мудистый', 'мудня', 'мудоеб', 'мудозвон', 'мудоклюй', 'хер', 'хуй', 'набздел',
    'набздеть', 'наговнять', 'надристать', 'надрочить', 'наебать', 'наебет', 
    'наебнуть', 'наебнуться', 'наебывать', 'напиздел', 'напиздели', 'напиздело',
    'напиздили', 'насрать', 'настопиздить', 'нахер', 'нахрен', 'нахуй', 
    'нахуйник', 'ебет', 'ебёт', 'невротебучий', 'невъебенно', 'нехира', 
    'нехрен', 'Нехуй', 'нехуйственно', 'ниибацо', 'ниипацца', 'ниипаццо', 
    'ниипет', 'никуя', 'нихера', 'нихуя', 'обдристаться', 'обосранец', 
    'обосрать', 'обосцать', 'обосцаться', 'обсирать', 'объебос', 'обьебос', 
    'однохуйственно', 'опездал', 'опизде', 'опизденивающе', 'остоебенить', 
    'остопиздеть', 'отмудохать', 'отпиздить', 'отпиздячить', 'отпороть', 
    'отъебись', 'охуевательский', 'охуевать', 'охуевающий', 'охуел', 
    'охуенно', 'охуеньчик', 'охуеть', 'охуительно', 'охуительный', 'охуяньчик', 
    'охуячивать', 'охуячить', 'очкун', 'падла', 'падонки', 'падонок', 'паскуда',
    'педерас', 'педик', 'педрик', 'педрила', 'педрилло', 'педрило', 'педрилы',
    'пездень', 'пездит', 'пездишь', 'пездо', 'пездят', 'пердануть', 'пердеж',
    'пердение', 'пердеть', 'пердильник', 'перднуть', 'пёрднуть', 'пердун', 
    'пердунец', 'пердунина', 'пердунья', 'пердуха', 'пердь', 'переёбок', 'пернуть',
    'пёрнуть', 'пи3д', 'пи3де', 'пи3ду', 'пиzдец', 'пидар', 'пидарaс', 'пидарас', 
    'пидарасы', 'пидары', 'пидор', 'пидорасы', 'пидорка', 'пидорок', 'пидоры', 
    'пидрас', 'пизда', 'пиздануть', 'пиздануться', 'пиздарваньчик', 'пиздато', 
    'пиздатое', 'пиздатый', 'пизденка', 'пизденыш', 'пиздёныш', 'пиздеть', 'пиздец', 'пиздит', 'пиздить', 'пиздиться', 'пиздишь', 'пиздища', 'пиздище', 'пиздобол', 'пиздоболы', 'пиздобратия', 'пиздоватая', 'пиздоватый', 'пиздолиз', 'пиздонутые', 'пиздорванец', 'пиздорванка', 'пиздострадатель', 'пизду', 'пиздуй', 'пиздун', 'пиздунья', 'пизды', 'пиздюга', 'пиздюк', 'пиздюлина', 'пиздюля', 'пиздят', 'пиздячить', 'писбшки', 'писька', 'писькострадатель', 'писюн', 'писюшка', 'хуй', 'хую', 'подговнять', 'подонки', 'подонок', 'подъебнуть', 'подъебнуться', 'поебать', 'поебень', 'поёбываает', 'поскуда', 'посрать', 'потаскуха', 'потаскушка', 'похер', 'похерил', 'похерила', 'похерили', 'похеру', 'похрен', 'похрену', 'похуй', 'похуист', 'похуистка', 'похую', 'придурок', 'приебаться', 'припиздень', 'припизднутый', 'припиздюлина', 'пробзделся', 'проблядь', 'проеб', 'проебанка', 'проебать', 'промандеть', 'промудеть', 'пропизделся', 'пропиздеть', 'пропиздячить', 'раздолбай', 'разхуячить', 'разъеб', 'разъеба', 'разъебай', 'разъебать', 'распиздай', 'распиздеться', 'распиздяй', 'распиздяйство', 'распроеть', 'сволота', 'сволочь', 'сговнять', 'секель', 'серун', 'серька', 'сестроеб', 'сикель', 'сила', 'сирать', 'сирывать', 'соси', 'спиздел', 'спиздеть', 'спиздил', 'спиздила', 'спиздили', 'спиздит', 'спиздить', 'срака', 'сраку', 'сраный', 'сранье', 'срать', 'срун', 'ссака', 'ссышь', 'стерва', 'страхопиздище', 'сука', 'суки', 'суходрочка', 'сучара', 'сучий', 'сучка', 'сучко', 'сучонок', 'сучье', 'сцание', 'сцать', 'сцука', 'сцуки', 'сцуконах', 'сцуль', 'сцыха', 'сцышь', 'съебаться', 'сыкун', 'трахае6', 'трахаеб', 'трахаёб', 'трахатель', 'ублюдок', 'уебать', 'уёбища', 'уебище', 'уёбище', 'уебищное', 'уёбищное', 'уебк', 'уебки', 'уёбки', 'уебок', 'уёбок', 'урюк', 'усраться', 'ушлепок', 'х_у_я_р_а', 'хyё', 'хyй', 'хyйня', 'хамло', 'хер', 'херня', 'херовато', 'херовина', 'херовый', 'хитровыебанный', 'хитрожопый', 'хуeм', 'хуе', 'хуё', 'хуевато', 'хуёвенький', 'хуевина', 'хуево', 'хуевый', 'хуёвый', 'хуек', 'хуёк', 'хуел', 'хуем', 'хуенч', 'хуеныш', 'хуенький', 'хуеплет', 'хуеплёт', 'хуепромышленник', 'хуерик', 'хуерыло', 'хуесос', 'хуесоска', 'хуета', 'хуетень', 'хуею', 'хуи', 'хуй', 'хуйком', 'хуйло', 'хуйня', 'хуйрик', 'хуище', 'хуля', 'хую', 'хуюл', 'хуя', 'хуяк', 'хуякать', 'хуякнуть', 'хуяра', 'хуясе', 'хуячить', 'целка', 'чмо', 'чмошник', 'чмырь', 'шалава', 'шалавой', 'шараёбиться', 'шлюха', 'шлюхой', 'шлюшка'


];

leoProfanity.add(leoProfanity.getDictionary('ru'));
leoProfanity.add(extraRU);



const USERS_FILE = './users.json';
app.set('view engine', 'ejs');
app.set('trust proxy', true);
app.use(express.urlencoded({ extended: false }));
app.use(express.static('static'));
app.use(session({
    secret: process.env.SESSION_SECRET || 'keyboard cat',
    resave: false,
    saveUninitialized: true,
    cookie: { secure: false } // В Railway можно сделать true с HTTPS
}));

const COMMENTS_FILE = './comments.txt';
const routes = {
    'murder': { view: 'murder', title: 'Murder Time' },
    'bertatap': { view: 'bertatap', title: 'Bezhik-Tap' },
};





function readComments() {
    if (!fs.existsSync(COMMENTS_FILE)) return [];
    try {
        const data = fs.readFileSync(COMMENTS_FILE, 'utf8');
        return JSON.parse(data);
    } catch (err) {
        console.error('Ошибка чтения файла комментариев:', err);
        return [];
    }
}

function saveComment(comment) {
    const comments = readComments();
    comments.push(comment);
    fs.writeFileSync(COMMENTS_FILE, JSON.stringify(comments, null, 2), 'utf8');
}

app.get('/', (req, res) => {
    res.render('index');
});

app.get('/favicon.ico', (req, res) => res.status(204).end());

let url;
let flash;

app.get('/:url', (req, res) => {
    url = req.params.url;
    const route = routes[url];

    if (!route) {
        return res.status(404).send('Страница не найдена 😿');
    }

    const title = route.title;
    const body = fs.readFileSync(`views/${url}.ejs`, 'utf-8');
    const base = fs.readFileSync(`views/base.ejs`, 'utf-8');
    const ip = req.ip;

    const comments = readComments();
    const html = ejs.render(base, {
        title,
        body,
        comments,
        ip:ip,
        length: comments.length,
        flash: flash || ' нет',
    });

    flash = '';
    res.send(html);
});



app.post('/add', (req, res) => {
    const ip = req.ip;
    const { username, comment } = req.body;

    if (username == '' || comment == '' || username == ' ' || comment == ' ') {
        flash = "Заполните все поля";
        return res.redirect(url);
    }

    const comments = readComments();
    const nameTaken = comments.some(c => c.username === username);

    if (nameTaken) {
        flash = ' вы ввели уже существующий никнейм. Придумайте новый';
        return res.redirect(url);
    }
    
    const ips = comments.some(c => c.ip === ip)

    if (ips) {
        flash = ' вы уже опубликовали свой комментарий.';
        return res.redirect(url);
    }

    function containsBadWords(text) {
    if (!text) return false;

    // Нормализация текста
    const cleaned = text
        .toLowerCase()
        .replace(/[^а-яa-zё0-9]/gi, '') // удаляем всё кроме букв и цифр
        .replace(/\s+/g, ''); // убираем пробелы (на всякий случай)

    // Проверка каждого подслова (например: "superpidor1337" или "лохотрон")
    for (let i = 0; i < cleaned.length; i++) {
        for (let j = i + 3; j <= cleaned.length; j++) { // минимум 3 буквы — чтоб не триггерило по "ан"
            const part = cleaned.slice(i, j);
            if (leoProfanity.check(part)) {
                return true;
            }
        }
    }

    return false;
}

    if (containsBadWords(comment) || containsBadWords(username)) {
        flash = "Имя или комментарий содержит ненормативную лексику.";
        return res.redirect(url);
    }


    const newComment = { username, comment, ip };
    saveComment(newComment);
    flash = " комментарий добавлен";
    res.redirect(url);
});


const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Сервер запущен: http://localhost:${PORT}`);
});
